<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lwt_canceler (lwt-canceler.Lwt_canceler)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0-beta2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../index.html">lwt-canceler</a> &#x00BB; Lwt_canceler</nav><header class="odoc-preamble"><h1>Module <code><span>Lwt_canceler</span></code></h1><h2 id="lwt_canceler"><a href="#lwt_canceler" class="anchor"></a><code>Lwt_canceler</code></h2><p>Lwt-canceler is a library for synchronizing cancellation of tasks and clean-up of associated resources in Lwt.</p></header><nav class="odoc-toc"><ul><li><a href="#states-and-transitions">States and transitions</a></li><li><a href="#callbacks">Callbacks</a></li><li><a href="#state-inspection">State inspection</a></li></ul></nav><div class="odoc-content"><h3 id="states-and-transitions"><a href="#states-and-transitions" class="anchor"></a>States and transitions</h3><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>A <code>Lwt_canceler.t</code> is a synchronization object that can be in either of three <a href="#val-state"><code>state</code></a>s: <em>waiting</em>, <em>canceling</em>, and <em>canceled</em>.</p><ul><li>When the synchronization object is <em>waiting</em>, you can attach callbacks using <a href="#val-on_cancel"><code>on_cancel</code></a>.</li><li>When the synchronization object is <em>waiting</em>, you can trigger the cancellation using <a href="#val-cancel"><code>cancel</code></a>, doing so changes the state of the synchronization object into <em>canceling</em> and triggers the execution of the attached callbacks.</li><li>When the callbacks have finished executing, the synchronization object's state changes to <em>canceled</em></li></ul></div></div><div class="odoc-spec"><div class="spec type" id="type-state" class="anchored"><a href="#type-state" class="anchor"></a><code><span><span class="keyword">type</span> state</span><span> = </span></code><table><tr id="type-state.Waiting" class="anchored"><td class="def variant constructor"><a href="#type-state.Waiting" class="anchor"></a><code><span>| </span><span><span class="constructor">Waiting</span></span></code></td></tr><tr id="type-state.Canceling" class="anchored"><td class="def variant constructor"><a href="#type-state.Canceling" class="anchor"></a><code><span>| </span><span><span class="constructor">Canceling</span></span></code></td></tr><tr id="type-state.Canceled" class="anchored"><td class="def variant constructor"><a href="#type-state.Canceled" class="anchor"></a><code><span>| </span><span><span class="constructor">Canceled</span></span></code></td></tr><tr id="type-state.Canceled_with_exception" class="anchored"><td class="def variant constructor"><a href="#type-state.Canceled_with_exception" class="anchor"></a><code><span>| </span><span><span class="constructor">Canceled_with_exception</span></span></code></td></tr></table></div><div class="spec-doc"><p>The <code>state</code> of a canceler. It is as described in the documentation of the type <a href="#type-t"><code>t</code></a>. The state <code>Canceled_with_exception</code> indicates that the canceler has been canceled but that exceptions have been raised during execution of the callbacks.</p><p>The exceptions raised during the execution of the callbacks are only available to the first caller of <a href="#val-cancel"><code>cancel</code></a>. The reasons for this are detailed in the documentation of <a href="#val-cancel"><code>cancel</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>unit <span>&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ()</code> returns a canceler in <em>waiting</em> state.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-cancel" class="anchored"><a href="#val-cancel" class="anchor"></a><code><span><span class="keyword">val</span> cancel : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> <span><span><span>(unit, <span>exn list</span>)</span> <a href="../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>cancel t</code> triggers the cancellation process and returns a promise <code>p</code>:</p><ol><li><code>t</code> changes state to <em>canceling</em>,</li><li>the callbacks attached to <code>t</code> execute sequentially in the order they were attached,</li><li>when the callbacks have all been executed, <code>t</code> changes state to <em>canceled</em> and <code>p</code> resolves.</li></ol><p>If <code>t</code> is in <em>canceling</em> state, <code>cancel t</code> returns a promise that resolves when <code>t</code> changes state to <em>canceled</em>. The call has no side-effects.</p><p>If <code>t</code> is already in <em>canceled</em> state, <code>cancel t</code> returns an already resolved promise.</p><p>If all the callbacks execute without raising exceptions and their promises are resolved successfully, then the promise returned by <code>cancel</code> resolves successfully with <code>Ok ()</code>.</p><p>If one or more of the attached callbacks raise exceptions or return promises that become rejected, the promise returned by one of the caller of <code>cancel</code> resolves to <code>Error excs</code> where <code>excs</code> is the (non-empty) list of exceptions that were raised. The promise returns by the other callers of <code>cancel</code> return a promise that resolve to <code>Error []</code>. This result indicates to these other callers that errors occurred but that they are not responsible for handling them.</p><p>The aim of this error management strategy is to ensure that errors are treated only once: one caller is responsible for handling the errors (closing some open file descriptors, freeing a lock, etc.), the others callers are not.</p></div></div><h3 id="callbacks"><a href="#callbacks" class="anchor"></a>Callbacks</h3><div class="odoc-spec"><div class="spec value" id="val-on_cancel" class="anchored"><a href="#val-on_cancel" class="anchor"></a><code><span><span class="keyword">val</span> on_cancel : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> <span><span>(<span>unit <span>&#45;&gt;</span></span> <span>unit <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span>)</span> <span>&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>on_cancel t callback</code>, if <code>t</code> is in <em>waiting</em> state, attaches <code>callback</code> to <code>t</code>.</p><p>When <code>t</code> becomes <em>canceling</em>, the callbacks are called sequentially, in FIFO order (meaning that the last callback added is executed last).</p><p>If one of the callback fails (i.e., if the promise returned by one of the callbacks is rejected), the following callbacks are executed nonetheless.</p><p>If one or more of the callbacks fail, then the first call to <a href="#val-cancel"><code>cancel</code></a> returns <code>Error _</code> as described above.</p><p>If <code>t</code> is in <em>canceling</em> or <em>canceled</em> state, <code>on_cancel t</code> is a no-op.</p></div></div><h3 id="state-inspection"><a href="#state-inspection" class="anchor"></a>State inspection</h3><div class="odoc-spec"><div class="spec value" id="val-canceling" class="anchored"><a href="#val-canceling" class="anchor"></a><code><span><span class="keyword">val</span> canceling : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>canceling t</code> is <code>true</code> iff <code>t</code> is <em>canceled</em> or <em>canceling</em>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-when_canceling" class="anchored"><a href="#val-when_canceling" class="anchor"></a><code><span><span class="keyword">val</span> when_canceling : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> <span>unit <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>when_canceling t</code> is a promise that is fulfilled when <code>t</code> enters the <em>canceling</em> state. If <code>t</code> is already in the <em>canceling</em> or <em>canceled</em> state, then the promise is already fulfilled.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-canceled" class="anchored"><a href="#val-canceled" class="anchor"></a><code><span><span class="keyword">val</span> canceled : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>canceled t</code> is <code>true</code> iff <code>t</code> is <em>canceled</em>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-when_canceled" class="anchored"><a href="#val-when_canceled" class="anchor"></a><code><span><span class="keyword">val</span> when_canceled : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> <span><span><span>(unit, <span>exn list</span>)</span> <a href="../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></span></code></div><div class="spec-doc"><p><code>when_canceled t</code> is a promise that is fulfilled when <code>t</code> enters the <em>canceled</em> state. If <code>t</code> is already in the <em>canceled</em> state, then the promise is already fulfilled.</p><p>It is fulfilled with the value <code>Ok ()</code> if the callbacks attached to <code>t</code> did not raise any exception, it is fulfilled with <code>Error []</code> otherwise. Check <a href="#val-cancel"><code>cancel</code></a> for additional information about error management.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-state" class="anchored"><a href="#val-state" class="anchor"></a><code><span><span class="keyword">val</span> state : <span><a href="#type-t">t</a> <span>&#45;&gt;</span></span> <a href="#type-state">state</a></span></code></div><div class="spec-doc"><p><code>state t</code> is the state of <code>t</code> at the moment of call.</p></div></div></div></body></html>