<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tezos_store__Cemented_block_store (tezos-store.Tezos_store__Cemented_block_store)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.0.0-beta2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> – <a href="../index.html">tezos-store</a> &#x00BB; Tezos_store__Cemented_block_store</nav><header class="odoc-preamble"><h1>Module <code><span>Tezos_store__Cemented_block_store</span></code></h1><p>Persistent block store with linear history</p><p>The cemented block store is a store where blocks are stored linearly (by level) in chunks. Blocks in this store should not be reorganized anymore and are thus *cemented*. As these blocks should not be accessed regularly and especially their optionally stored metadata, the later are compressed using a zip format to save disk space. For each chunk of blocks, a dedicated file is used. Moreover, to enable easy access and to prevent too much on-disk reading, two indexed maps are used to retrieve blocks hash from their level and their level from the block hash.</p><p>The cemented block store contains a set of files updated each time a new chunk is added to the store. These files indicate which interval of blocks (w.r.t. their levels) are stored in it.</p><h2 id="invariants"><a href="#invariants" class="anchor"></a>Invariants</h2><p>This store is expected to respect the following invariants:</p><ul><li>A key/value present in an index is present as well in the other as value/key.</li></ul><ul><li>Every block stored is correctly referenced through its associated indexes.</li></ul><ul><li>A cemented chunk of blocks that is represented by the interval <code> i ; j </code> (with i &lt;= j) contains | j - i + 1 | blocks and are ordered from i to j in the file.</li></ul><ul><li>The set F of cemented chunks is always ordered by block level.</li></ul><ul><li>The cemented store does not contain holes: let F be the cemented chunks, if |F| &gt; 1 then:</li></ul><pre>      ∀f_x=(i,j) ∈ F ∧ x &lt; |F|, ∃f_y =(i', j'), x = y - 1 ∧ j + 1 = j'</pre><p>meaning the concatenation of every chunk must be continuous.</p><ul><li>A metadata zip file is indexed by the same interval as the chunks and, when it is the lowest chunk of metadata stored, is not assured to contain every block's metadata of the chunk.</li></ul><h2 id="files-format"><a href="#files-format" class="anchor"></a>Files format</h2><p>The cemented block store is composed of the following files:</p><ul><li>file: /&lt;i_j&gt;, a chunk of blocks from level i to level j. The format of this file is:</li></ul><p>| &lt;n&gt; × &lt;offset&gt; | &lt;n&gt; × &lt;block&gt; |</p><p>where n is (j - i + 1), &lt;offset&gt; is a 4 bytes integer representing the absolute offset of a block where the k-th (with 0 &lt;= k &lt; n) offset stands for the absolute offset of the k-th block in the file and with &lt;block&gt;, a <code>Block_repr</code>.t value encoded using <code>Block_repr</code>.encoding (thus prefixed by the its size).</p><ul><li>dir: /cemented_block_index_level, the Hash -&gt; Level key/value index ;</li></ul><ul><li>dir: /cemented_block_index_hash, the Level -&gt; Hash key/value index.</li></ul><ul><li>dir: /metadata, the directory containing chunks of compressed metadata (present if relevant).</li></ul><ul><li>files: /metadata/&lt;i_j&gt;.zip, the compressed metadata where every chunk of block's metadata is indexed by their level encoded as string (present if relevant).</li></ul></header><div class="odoc-content"></div></body></html>